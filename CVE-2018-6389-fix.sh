#!/bin/bash
#
# SECURITY PATCH FOR CVE-2018-6389 Wordpress VULNERABILITY
#
# Copyright (C) 2006-2018 Avihai Naor hershkovitz
# This software is the property of JetServer Ltd.
#
# based on the solution by: Quitten
# https://github.com/Quitten/WordPress/commit/58b460ad00b0d66aaefd2de15c340f6e31f240d0
#
# Use at your own risk!
#

clear

workingDir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
genRand=$(shuf -i 10-99 -n 1)
greenText='\033[01;32m'
redText='\e[31m'
resetText='\033[0m'

gen_intro(){
  echo -e "${greenText}*************************************************************${resetText}"
  echo -e "          JETSERVER Wordpress CVE-2018-6389 Global Fix                               "
  echo -e "${greenText}*************************************************************${resetText}"
  echo -e ""
  echo -e "This script will locate all of the Wordpress installations"
  echo -e "on this server and will run the security patch on each and"
  echo -e "and everyone of them."
  echo -e ""
  echo -e "Use at your own risk!"
  echo -e ""
  echo -e "${greenText}*************************************************************${resetText}"
  echo -e ""

  while true; do
    read -p "Would you like to proceed? " yn
    case $yn in
        [Yy]* ) main;;
        [Nn]* ) exit;;
        * ) echo "Please answer yes or no.";;
    esac
  done
}

reset_counter(){
  multiCounter=1
}

patch_wp(){
  for wpSite in $(cat "${workingDir}"/wpSitesLoc.log); do
    dOwner=$(stat -c '%U' "${wpSite}")
      if [ ! -f "${wpSite}"/wp-admin/includes/noop.php ]; then
        echo -e "${redText}[ NOOP.PHP FILE NOT FOUND ]${resetText} ${wpSite}" >> "${workingDir}"/patched.log
      else
        wasPatched=$(grep -o "load-scripts.php" "${wpSite}"/wp-admin/includes/noop.php)
      fi
      if [ ! -z "${wasPatched}" ]; then
        echo -e "${redText}[ ALREADY PATCHED ]${resetText} ${wpSite}" >> "${workingDir}"/patched.log
      else
        cd "${wpSite}"
      if [ ! -f "${wpSite}"/wp-login.php ]; then
        echo -e "${redText}[ WP-INDEX.PHP NOT FOUND ]${resetText} ${wpSite}" >> "${workingDir}"/patched.log
      else
        cp "${wpSite}"/wp-login.php "${wpSite}"/wp-login.php.bk
        cp "${wpSite}"/wp-admin/load-scripts.php "${wpSite}"/wp-admin/load-scripts.php.bk
        cp "${wpSite}"/wp-admin/load-styles.php "${wpSite}"/wp-admin/load-styles.php.bk
        cp "${wpSite}"/wp-admin/includes/noop.php "${wpSite}"/wp-admin/includes/noop.php.bk
      fi
        sed -i "1 s/^.*$/<?php\ndefine('CONCATENATE_SCRIPTS', false);/" "${wpSite}"/wp-login.php
        sed -i -e "s/^require( ABSPATH . WPINC . '\/script-loader.php' );$/require( ABSPATH . 'wp-admin\/admin.php' );/g" "${wpSite}"/wp-admin/load-scripts.php
        sed -i -e "s/^require( ABSPATH . WPINC . '\/script-loader.php' );$/require( ABSPATH . 'wp-admin\/admin.php' );/g" "${wpSite}"/wp-admin/load-styles.php

        echo """<?php
        /**
        * Noop functions for load-scripts.php and load-styles.php.
        *
        * @package WordPress
        * @subpackage Administration
        * @since 4.4.0
        */
        function get_file( \$path ) {
          if ( function_exists('realpath') ) {
            \$path = realpath( \$path );
          }
          if ( ! \$path || ! @is_file( \$path ) ) {
            return '';
          }
          return @file_get_contents( \$path );
        }""" > "${wpSite}"/wp-admin/includes/noop.php

        echo -e "${multiCounter}-${greenText}[ PATCHED ]${resetText} ${wpSite}" >> "${workingDir}"/patched.log

        cd "${workingDir}"
        multiCounter=$(( ${multiCounter}+1 ))

      fi

      if [ -f "${wpSite}"/wp-login.php.bk ]; then
        chown "${dOwner}"."${dOwner}" "${wpSite}"/wp-login.php.bk
      else
        echo -e "${multiCounter}-${redText}[ CANNOT CHOWN WP-LOGIN.PHP.BK ]${resetText} ${wpSite}" >> "${workingDir}"/patched.log
      fi
      if [ -f "${wpSite}"/wp-admin/load-scripts.php.bk ]; then
        chown "${dOwner}"."${dOwner}" "${wpSite}"/wp-admin/load-scripts.php.bk
      else
        echo -e "${multiCounter}-${redText}[ CANNOT CHOWN LOAD-SCRIPTS.PHP.BK ]${resetText} ${wpSite}" >> "${workingDir}"/patched.log
      fi
      if [ -f "${wpSite}"/wp-admin/load-styles.php.bk ]; then
        chown "${dOwner}"."${dOwner}" "${wpSite}"/wp-admin/load-styles.php.bk
      else
        echo -e "${multiCounter}-${redText}[ CANNOT CHOWN LOAD-STYLES.PHP.BK ]${resetText} ${wpSite}" >> "${workingDir}"/patched.log
      fi
      if [ -f "${wpSite}"/wp-admin/includes/noop.php ]; then
        chown "${dOwner}"."${dOwner}" "${wpSite}"/wp-admin/includes/noop.php
      else
        echo -e "${multiCounter}-${redText}[ CANNOT CHOWN NOOP.PHP ]${resetText} ${wpSite}" >> "${workingDir}"/patched.log
      fi
      if [ -f "${wpSite}"/wp-admin/includes/noop.php.bk ]; then
        chown "${dOwner}"."${dOwner}" "${wpSite}"/wp-admin/includes/noop.php.bk
      else
        echo -e "${multiCounter}-${redText}[ CANNOT CHOWN NOOP.PHP.BK ]${resetText} ${wpSite}" >> "${workingDir}"/patched.log
      fi

  done
  cat "${workingDir}"/patched.log
  echo ""
  exit 1
}

generate_list(){
  echo -e "${greenText}GENERATING A LIST OF ALL WORDPRESS INSTALLATIONS ON THE SERVER\n${resetText}"
  echo -e "Please Wait ... \n"
  ls -d /home/*/*/wp-admin | sed 's/wp-admin//g' |  sed 's/.\{1\}$//' >> "${workingDir}"/wpSitesLoc.log
  if [ 'ls -d /home/*/*/*/wp-admin' ]; then
    ls -d /home/*/*/*/wp-admin | sed 's/wp-admin//g' |  sed 's/.\{1\}$//' >> "${workingDir}"/wpSitesLoc.log
  fi
  reset_counter
  patch_wp
}

init_checks(){
    mv "${workingDir}"/wpSitesLoc.log "${workingDir}"/wpSitesLoc-"${genRand}".log
    mv "${workingDir}"/patched.log "${workingDir}"/patched-"${genRand}".log
    touch "${workingDir}"/wpSitesLoc.log
    generate_list
}

main(){
  init_checks
}

gen_intro
